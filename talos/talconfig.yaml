---
clusterName: homelab
endpoint: "https://${CONTROL_PLANE_VIP}:6443"

# renovate: datasource=github-releases depName=siderolabs/talos
talosVersion: v1.11.2
# renovate: datasource=github-releases depName=siderolabs/kubelet
kubernetesVersion: v1.34.1

controlPlane:
  patches:
    - "@./patches/machine/vip.yaml"
    - "@./patches/cluster/kube-proxy.yaml"
    - "@./patches/cluster/metrics.yaml"

  schematic: &schematic
    customization:
      extraKernelArgs: &extraKernelArgs
        - talos.platform=metal
      systemExtensions: &systemExtensions
        officialExtensions:
          - siderolabs/intel-ucode
          - siderolabs/iscsi-tools
          - siderolabs/util-linux-tools

worker:
  schematic: *schematic

allowSchedulingOnControlPlanes: true

cniConfig:
  name: none

patches:
  - "@./patches/machine/kubelet.yaml"
  - "@./patches/machine/longhorn.yaml"
  - "@./patches/machine/features.yaml"
  - "@./patches/machine/certsans.yaml"
  - "@./patches/cluster/coredns.yaml"
  - "@./patches/cluster/admission_control.yaml"
  - "@./patches/cluster/env.yaml"

nodes:
  # Test nodes on Vagrant
  - hostname: worker
    ipAddress: worker.local
    installDisk: /dev/vda
    controlPlane: false
  - hostname: controller
    ipAddress: controller.local
    installDisk: /dev/vda
    controlPlane: true

  # Real nodes for prod
  - hostname: athena
    ipAddress: 192.168.10.2
    installDisk: /dev/mmcblk0
    controlPlane: false
    nodeLabels:
      kalexlab.xyz/node: vpn
    schematic:
      overlay:
        image: siderolabs/sbc-raspberrypi
        name: rpi_generic
      customization:
        extraKernelArgs: *extraKernelArgs
        systemExtensions:
          officialExtensions:
            - siderolabs/iscsi-tools
            - siderolabs/util-linux-tools
    # Due to NodeApplyController, it is only possible to taint
    # a node when it is first registered
    #   ref: https://github.com/siderolabs/talos/discussions/9895
    patches:
      - "@./patches/machine/taint.yaml"

  - hostname: hermes
    ipAddress: 192.168.10.3
    installDisk: /dev/nvme0n1
    controlPlane: false
    userVolumes:
      - name: longhorn
        provisioning:
          diskSelector:
            match: "'/dev/disk/by-id/ata-CT1000MX500SSD1_2406E89658C0' in disk.symlinks"
          minSize: "900GiB" # Talos will autogrow the size if more is available
          grow: true
      - name: backups
        provisioning:
          diskSelector:
            match: "'/dev/disk/by-id/ata-WDC_WD10SDRW-34A0XS1_WD-WXA2A41N3VKR' in disk.symlinks"
          minSize: "900GiB"
          grow: true

  - hostname: zeus
    ipAddress: 192.168.10.4
    installDisk: /dev/nvme0n1
    controlPlane: true
    userVolumes:
      - name: longhorn
        provisioning:
          diskSelector:
            match: "'/dev/disk/by-id/ata-CT1000MX500SSD1_2434E988FA39' in disk.symlinks"
          minSize: "900GiB" # Talos will autogrow the size if more is available
          grow: true
    schematic:
      customization:
        extraKernelArgs:
          - talos.platform=metal
          # ASPM gives PCIe errors on this node
          # Power efficiency looks OK even without ASPM (~7-10W idle)
          - pcie_aspm=off
        systemExtensions: *systemExtensions
